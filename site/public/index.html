<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Collects.art</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/3.7.8/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/3.7.8/firebase-auth.js"></script>
    <script defer src="/__/firebase/3.7.8/firebase-database.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <style media="screen"></style>
  </head>
  <body onload="init()">
    <div id="collects" style="display:none">
      <h1>Collects</h1>
    </div>
    <div id="collect" style="display:none"></div>
    <p id="load">...</p>
    <hr>
    <small>Created in 2017 for <a href='https://sevenonseven.art'>Seven on Seven</a> by Nozlee Samadzadeh and Bunny Rogers</small>

    <script>
      var load = document.getElementById('load');

      function init() {
        firebase.auth().signInAnonymously().then(() => {
          var timestamp = window.location.pathname.slice(1).split('/')[0];
          if (!timestamp) {
            return loadCollects();
          } else {
            return loadCollect(timestamp);
          }
        }).catch((e) => {
          load.innerHTML = 'oops';
          console.error(e);
        });
      }

      function loadCollects() {
        return firebase.database().ref('/users').once('value').then(snapshot => {
          var collectsDiv = document.getElementById('collects');
          var table = document.createElement('table');
          var users = snapshot.exportVal();
          Object.keys(users).forEach((uid) => {
            var user = users[uid];

            if (user.collects && Object.keys(user.collects)) {
              var ribbon = document.createElement('img');
              ribbon.src = user.ribbon;
              ribbon.style.height = '50px';

              var userTd = document.createElement('td');
              userTd.appendChild(ribbon)

              var entriesTd = document.createElement('td');
              var ul = document.createElement('ul');
              Object.keys(user.collects).forEach((timestamp) => {
                var collect = user.collects[timestamp];
                var li = document.createElement("li");
                var a = document.createElement('a');
                a.appendChild(document.createTextNode(collect.title));
                a.href = '/' + timestamp + '/' + collect.title;
                li.appendChild(a);
                ul.appendChild(li);
              });
              entriesTd.appendChild(ul);

              var tr = document.createElement('tr');
              tr.appendChild(userTd);
              tr.appendChild(entriesTd);
              table.appendChild(tr);
            }

            collectsDiv.appendChild(table);
          });

          collectsDiv.style.display = 'initial';
          load.style.display = 'none';
        });
      }

      function loadCollect(timestamp) {
        return firebase.database().ref('/collects/' + timestamp).once('value').then(snapshot => {
          var collect = snapshot.exportVal();

          window.history.replaceState(window.history.state, document.title, '/' + timestamp + '/' + collect.title);
          document.title = collect.title;

          return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            var headers = {
              'Content-Type': 'application/json',
              Accept: 'text/html'
            };

            var handleXhrError = (message) => {
              var error = new Error(message);
              return reject(error);
            };

            xhr.onerror = () => handleXhrError('An network error occurred.');
            xhr.ontimeout = () => handleXhrError('The XMLHttpRequest timed out.');

            xhr.onload = () => {
              if (xhr.status < 200 || xhr.status >= 300) {
                var error = new HttpStatusError(`Response status not within range: ${xhr.status}`, xhr);
                return reject(error);
              }
              return resolve(xhr.response);
            };

            xhr.open('POST', 'https://us-central1-' + firebase.app().options.authDomain.split('.')[0] + '.cloudfunctions.net/template', true);
            xhr.send(JSON.stringify(collect));
          }).then((html) => {
            var collectDiv = document.getElementById('collect');
            collectDiv.style.display = 'initial';
            collectDiv.innerHTML = html;
            load.style.display = 'none';
          });

          // // NSDate's timeIntervalSince1970 is missing milliseconds
          // var date = new Date(timestamp * 1000);
          // var datestring = `
          //   ${date.getFullYear()}
          //   ${date.getMonth() < 9 ? '0' : ''}${date.getMonth() + 1}
          //   ${date.getDate() < 10 ? '0' : ''}${date.getDate()}
          // `.replace(/\s/g, '');
        });
      }
    </script>
  </body>
</html>
